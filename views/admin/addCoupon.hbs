<aside class="navbar-aside" id="offcanvas_aside">
    <div class="aside-top">
        <a href="/admin/home" class="brand-wrap">
            <img src="/assetsAdmin/imgs/theme/logo.svg" class="logo" alt="Evara Dashboard">
        </a>
        <div>
            <button class="btn btn-icon btn-aside-minimize"> 
                <i class="text-muted material-icons md-menu_open"></i>
            </button>
        </div>
    </div>
    <nav>
        <ul class="menu-aside">
            <li class="menu-item">
                <a class="menu-link" href="/admin/home"> 
                    <i class="icon material-icons md-home"></i>
                    <span class="text">Dashboard</span>
                </a>
            </li>
            <li class="menu-item">
                <a class="menu-link" href="/admin/product"> 
                    <i class="icon material-icons md-shopping_bag"></i>
                    <span class="text">Products</span>
                </a>
            </li>
            <li class="menu-item">
                <a class="menu-link" href="/admin/orders"> 
                    <i class="icon material-icons md-shopping_cart"></i>
                    <span class="text">Orders</span>
                </a>
            </li>
            <li class="menu-item">
                <a class="menu-link" href="/admin/category"> 
                    <i class="icon material-icons md-category"></i>
                    <span class="text">Category</span>
                </a>
            </li>
            <li class="menu-item active">
                <a class="menu-link" href="/admin/coupons">
                    <i class="icon fa-solid fa-ticket"></i>
                    <span class="text">Coupons</span>
                </a>
            </li>
            <li class="menu-item">
                <a class="menu-link" href="/admin/manage_users"> 
                    <i class="icon material-icons md-person"></i>
                    <span class="text">Users</span>
                </a>
            </li>
            <li class="menu-item">
                <a class="menu-link" href="/admin/banners"> 
                    <i class="icon material-icons md-local_offer"></i>
                    <span class="text">Banner</span>
                </a>
            </li>
            <li class="menu-item">
                <a class="menu-link" href="/admin/reviews"> 
                    <i class="icon material-icons md-comment"></i>
                    <span class="text">Reviews</span>
                </a>
            </li>
            <li class="menu-item">
                <a class="menu-link" href="/admin/brands"> 
                    <i class="icon material-icons md-stars"></i>
                    <span class="text">Brands</span> 
                </a>
            </li>
        </ul>
        <hr>
        <ul class="menu-aside">
            <li class="menu-item">
                <a class="menu-link" href="#"> 
                    <i class="icon material-icons md-settings"></i>
                    <span class="text">Settings</span>
                </a>
            </li>
            <li class="menu-item">
                <a class="menu-link btn btn-primary" href="/admin/logout"> 
                    <i class="icon material-icons md-exit_to_app"></i>
                    Logout
                </a>
            </li>
        </ul>
        <br><br>
    </nav>
</aside>

<main class="main-wrap">
    <section class="content-main">
        <div class="row justify-content-center align-items-center">
            <div class="col-lg-8 mt-5">
                <div class="card">
                    <div class="card-body">
                        {{#if couponMsg}}
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            {{couponMsg}}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {{/if}}
                        {{#if couponExMsg}}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            {{couponExMsg}}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {{/if}}

                        <form action="/admin/add_coupon" method="post" onsubmit="return validationf(this)" class="row g-3">
                            <h5 class="content-title mb-4">Add New Coupon</h5>

                            <div class="col-12">
                                <label for="coupon-code" class="form-label">Coupon Code <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="coupon-code" placeholder="e.g. SUMMER25" name="code" required>
                                <div class="invalid-feedback" id="couponcodealert"></div>
                            </div>

                            <div class="col-12">
                                <label for="discount" class="form-label">Discount Percentage <span class="text-danger">*</span></label>
                                <div class="input-group mb-3">
                                    <input type="number" class="form-control" id="discount" name="percent" 
                                           placeholder="e.g. 25" min="1" max="90" required>
                                    <span class="input-group-text">%</span>
                                </div>
                                <div class="invalid-feedback" id="discountalert"></div>
                            </div>

                            <div class="col-12">
                                <label for="min-purchase" class="form-label">Minimum Purchase Amount <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="min-purchase" 
                                       placeholder="e.g. 999" name="minPurchase" min="0" required>
                                <div class="invalid-feedback" id="minalert"></div>
                            </div>

                            <div class="col-12">
                                <label for="max-discount" class="form-label">Maximum Discount Amount <span class="text-danger">*</span></label>
                                <div class="input-group mb-3">
                                    <input type="number" class="form-control" id="max-discount" 
                                           placeholder="e.g. 500" name="maxDiscount" min="0" required>
                                    <span class="input-group-text">₹</span>
                                </div>
                                <div class="invalid-feedback" id="maxalert"></div>
                            </div>

                            <div class="col-12">
                                <label for="expiry-date" class="form-label">Expiry Date <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="expiry-date" name="expDate" 
                                       min="{{todayFormatted}}" required>
                                <div class="invalid-feedback" id="expiryalert"></div>
                            </div>

                            <div class="col-12 text-center mt-4">
                                <button type="submit" class="btn btn-primary px-5 me-3">Add Coupon</button>
                                <a href="/admin/coupons" class="btn btn-outline-secondary px-5" id="backbutton">Back</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="main-footer font-xs">
        <div class="row pb-30 pt-15">
            <div class="col-sm-6">
                <script>document.write(new Date().getFullYear())</script> ©, BashaBook
            </div>
            <div class="col-sm-6">
                <div class="text-sm-end">
                    All rights reserved
                </div>
            </div>
        </div>
    </footer>
</main>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // Set minimum date to today
    document.addEventListener("DOMContentLoaded", function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById("expiry-date").setAttribute("min", today);
    });

    // SweetAlert confirmation for Back button
    $(document).ready(function () {
        $('#backbutton').click(function (e) {
            e.preventDefault();

            Swal.fire({
                title: "Leave this page?",
                text: "Any unsaved changes will be lost",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#088178",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, leave",
                cancelButtonText: "Stay"
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = "/admin/coupons";
                }
            });
        });
    });

    function validationf(form) {
        const errors = [];

        const couponCode = document.getElementById('coupon-code').value.trim();
        const discount = parseFloat(document.getElementById('discount').value);
        const minPurchase = parseFloat(document.getElementById('min-purchase').value);
        const maxDiscount = parseFloat(document.getElementById('max-discount').value);
        const expiryDate = document.getElementById('expiry-date').value;

        // Error elements
        const couponErr = document.getElementById('couponcodealert');
        const discountErr = document.getElementById('discountalert');
        const minErr = document.getElementById('minalert');
        const maxErr = document.getElementById('maxalert');
        const expiryErr = document.getElementById('expiryalert');

        // Reset previous errors
        [couponErr, discountErr, minErr, maxErr, expiryErr].forEach(el => {
            el.textContent = '';
            el.classList.remove('d-block');
        });

        // Validation rules
        if (!/^[A-Z0-9]{4,15}$/.test(couponCode.toUpperCase())) {
            errors.push('Coupon code must be 4-15 alphanumeric characters (no spaces)');
        }

        if (isNaN(discount) || discount < 1 || discount > 90) {
            errors.push('Discount must be between 1 and 90%');
        }

        if (isNaN(minPurchase) || minPurchase < 0) {
            errors.push('Minimum purchase amount cannot be negative');
        }

        if (isNaN(maxDiscount) || maxDiscount < 0) {
            errors.push('Maximum discount amount cannot be negative');
        }

        if (!expiryDate) {
            errors.push('Please select an expiry date');
        }

        if (errors.length > 0) {
            // Show errors under respective fields
            if (errors.some(e => e.includes('Coupon code'))) {
                couponErr.textContent = 'Coupon code must be 4-15 alphanumeric characters (no spaces)';
                couponErr.classList.add('d-block');
            }
            if (errors.some(e => e.includes('Discount'))) {
                discountErr.textContent = 'Discount must be between 1 and 90%';
                discountErr.classList.add('d-block');
            }
            if (errors.some(e => e.includes('Minimum purchase'))) {
                minErr.textContent = 'Minimum purchase amount cannot be negative';
                minErr.classList.add('d-block');
            }
            if (errors.some(e => e.includes('Maximum discount'))) {
                maxErr.textContent = 'Maximum discount amount cannot be negative';
                maxErr.classList.add('d-block');
            }
            if (errors.some(e => e.includes('expiry'))) {
                expiryErr.textContent = 'Please select an expiry date';
                expiryErr.classList.add('d-block');
            }

            return false;
        }

        return true;
    }
</script>