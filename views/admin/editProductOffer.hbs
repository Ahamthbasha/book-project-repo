<aside class="navbar-aside" id="offcanvas_aside">
    <div class="aside-top">
        <a href="/admin/home" class="brand-wrap">
            <img src="/assetsAdmin/imgs/theme/logo.svg" class="logo" alt="Evara Dashboard">
        </a>
        <div>
            <button class="btn btn-icon btn-aside-minimize"> <i class="text-muted material-icons md-menu_open"></i>
            </button>
        </div>
    </div>
    <nav>
        <ul class="menu-aside">
            <li class="menu-item">
                <a class="menu-link" href="/admin/home"> <i class="icon material-icons md-home"></i>
                    <span class="text">Dashboard</span>
                </a>
            </li>
            <li class="menu-item">
                <a class="menu-link" href="/admin/product"> <i class="icon material-icons md-shopping_bag"></i>
                    <span class="text">Products</span>
                </a>
            </li>
            <li class="menu-item">
                <a class="menu-link" href="/admin/orders"> <i class="icon material-icons md-shopping_cart"></i>
                    <span class="text">Orders</span>
                </a>
            </li>
            <li class="menu-item">
                <a class="menu-link" href="/admin/category"> <i class="icon material-icons md-category"></i>
                    <span class="text">Category</span>
                </a>
            </li>
            <li class="menu-item">
                <a class="menu-link" href="/admin/coupons"><i class="icon fa-solid fa-ticket"></i>
                    <span class="text">Coupons</span>
                </a>
            </li>
            <li class="menu-item">
                <a class="menu-link" href="/admin/manage_users"> <i class="icon material-icons md-person"></i>
                    <span class="text">Users</span>
                </a>
            </li>
        </ul>
        <hr>
        <ul class="menu-aside">
            <li class="menu-item active">
                <a class="menu-link" href="/admin/productOffers"> 
                    <i class="icon material-icons md-local_offer"></i>
                    <span class="text">Product Offer</span>
                </a>
            </li>
            <li class="menu-item">
                <a class="menu-link" href="/admin/categoryOffers"> 
                    <i class="icon material-icons md-local_offer"></i>
                    <span class="text">Category Offer</span>
                </a>
            </li>
            <li class="menu-item">
                <a class="menu-link btn btn-primary" href="/admin/logout"> <i class="icon material-icons md-exit_to_app"></i>
                    Logout
                </a>
            </li>
        </ul>
        <br>
        <br>
    </nav>
</aside>

<main class="main-wrap">
    <section class="content-main">
        <div class="row justify-content-center align-items-center">
            <div class="col-10">
                <div class="content-header">
                    <h2 class="content-title">Edit Product Offer</h2>
                </div>
            </div>
            <div class="col-lg-8 mt-5 justify-content-center">
                <div class="card">
                    <div class="card-body">
                        <form action="/admin/editProductOffer/{{editProductOfferData._id}}" id="editProductOfferForm" role="form" method="post">
                            <input type="hidden" name="offerId" value="{{editProductOfferData._id}}" />
                            
                            <div class="modal-body">
                                <label for="productName" class="mb-2">Product Name:</label>
                                <select name="productName" id="productName" class="form-select" required>
                                    {{#each products}}
                                    <option value="{{this.name}}" {{#if (eq this.name ../editProductOfferData.productName)}}selected{{/if}}>
                                        {{this.name}}
                                    </option>
                                    {{/each}}
                                </select>

                                <div class="offerPercentageInput p-2">
                                    <label for="productOfferPercentage" class="mb-2">Product Offer Percentage: </label>
                                    <div class="input-group">
                                        <input id="productOfferPercentage" 
                                               value="{{editProductOfferData.productOfferPercentage}}" 
                                               name="productOfferPercentage" 
                                               class="form-control"
                                               type="number"
                                               min="5"
                                               max="90"
                                               step="1"
                                               placeholder="Enter the offer percentage"
                                               required>
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <div class="form-text">Choose a percentage to be discounted. Between 5% and 90%.</div>
                                    <div id="percentageError" class="text-danger" style="display:none;"></div>
                                </div>
                                
                                <div class="startDateInput p-2">
                                    <label for="startDate">Offer Start Date: </label>
                                    <div class="input-group">
                                        <input id="startDate" 
                                               value="{{startDate}}" 
                                               name="startDate" 
                                               type="date" 
                                               class="form-control"
                                               required>
                                    </div>
                                    <div class="form-text">Choose a start date for the offer (today or future date).</div>
                                    <div id="startDateError" class="text-danger" style="display:none;"></div>
                                </div>

                                <div class="endDateInput p-2">
                                    <label for="endDate">Offer Expiry Date: </label>
                                    <div class="input-group">
                                        <input id="endDate" 
                                               value="{{endDate}}" 
                                               name="endDate" 
                                               type="date" 
                                               class="form-control"
                                               required>
                                    </div>
                                    <div class="form-text">Choose an expiry date for offer (must be after start date).</div>
                                    <div id="endDateError" class="text-danger" style="display:none;"></div>
                                </div>
                            </div>

                            <div class="modal-footer">
                                <a href="/admin/productOffers" class="btn btn-secondary">Back</a>
                                <button type="submit" class="btn btn-info">Save changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="main-footer font-xs">
        <div class="row pb-30 pt-15">
            <div class="col-sm-6">
                <script>
                    document.write(new Date().getFullYear())
                </script> Â©, BashaBook.
            </div>
            <div class="col-sm-6">
                <div class="text-sm-end">
                    All rights reserved
                </div>
            </div>
        </div>
    </footer>
</main>

<script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>

<script>
    $(document).ready(function () {
        // Set minimum date to today for start date
        const today = new Date().toISOString().split('T')[0];
        $('#startDate').attr('min', today);
        
        // Update end date minimum when start date changes
        $('#startDate').on('change', function() {
            const startDate = $(this).val();
            if (startDate) {
                // End date must be after start date
                const minEndDate = new Date(startDate);
                minEndDate.setDate(minEndDate.getDate() + 1);
                $('#endDate').attr('min', minEndDate.toISOString().split('T')[0]);
                
                // Clear end date if it's before or equal to start date
                const currentEndDate = $('#endDate').val();
                if (currentEndDate && currentEndDate <= startDate) {
                    $('#endDate').val('');
                }
            }
        });

        // Set initial end date minimum based on current start date
        const currentStartDate = $('#startDate').val();
        if (currentStartDate) {
            const minEndDate = new Date(currentStartDate);
            minEndDate.setDate(minEndDate.getDate() + 1);
            $('#endDate').attr('min', minEndDate.toISOString().split('T')[0]);
        }

        // Validate percentage input
        $('#productOfferPercentage').on('input', function() {
            const value = parseFloat($(this).val());
            const errorDiv = $('#percentageError');
            
            if (isNaN(value) || value < 5 || value > 90) {
                errorDiv.text('Percentage must be between 5 and 90').show();
                $(this).addClass('is-invalid');
            } else {
                errorDiv.hide();
                $(this).removeClass('is-invalid');
            }
        });

        // Form submission validation
        $('#editProductOfferForm').on('submit', function(e) {
            let isValid = true;
            
            // Validate percentage
            const percentage = parseFloat($('#productOfferPercentage').val());
            if (isNaN(percentage) || percentage < 5 || percentage > 90) {
                $('#percentageError').text('Percentage must be between 5 and 90').show();
                $('#productOfferPercentage').addClass('is-invalid');
                isValid = false;
            } else {
                $('#percentageError').hide();
                $('#productOfferPercentage').removeClass('is-invalid');
            }
            
            // Validate dates
            const startDate = new Date($('#startDate').val());
            const endDate = new Date($('#endDate').val());
            const todayDate = new Date();
            todayDate.setHours(0, 0, 0, 0);
            
            // Check start date is today or future
            if (startDate < todayDate) {
                $('#startDateError').text('Start date must be today or a future date').show();
                $('#startDate').addClass('is-invalid');
                isValid = false;
            } else {
                $('#startDateError').hide();
                $('#startDate').removeClass('is-invalid');
            }
            
            // Check end date is after start date
            if (endDate <= startDate) {
                $('#endDateError').text('End date must be after start date').show();
                $('#endDate').addClass('is-invalid');
                isValid = false;
            } else {
                $('#endDateError').hide();
                $('#endDate').removeClass('is-invalid');
            }
            
            if (!isValid) {
                e.preventDefault();
                // Scroll to first error
                $('html, body').animate({
                    scrollTop: $('.is-invalid').first().offset().top - 100
                }, 500);
                return false;
            }
        });
    });
</script>