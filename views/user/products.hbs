<style>
/* CSS for highlighted filter option */
.highlight {
    background-color: #A8D5BA;
    color: white;
    font-weight: bold;
    padding: 5px 10px;
    border-radius: 5px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.highlight:hover {
    background-color: #8FBC8F;
    transform: scale(1.05);
}

/* Search bar styling */
.product-search-wrapper {
    margin-bottom: 20px;
}

.product-search-input {
    width: 100%;
    padding: 12px 20px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.product-search-input:focus {
    outline: none;
    border-color: #088178;
    box-shadow: 0 0 5px rgba(8, 129, 120, 0.2);
}
</style>

<main class="main">
    <!-- Breadcrumb -->
    <div class="page-header breadcrumb-wrap">
        <div class="container">
            <div class="breadcrumb">
                <a href="/" rel="nofollow">Home</a>
                <span></span> Shop
            </div>
        </div>
    </div>

    <section class="mt-50 mb-50">
        <div class="container">
            <div class="row flex-row-reverse">
                <div class="col-lg-9">
                    <!-- Search Bar -->
                    <div class="product-search-wrapper">
                        <input 
                            type="text" 
                            id="productSearchInput" 
                            class="product-search-input" 
                            placeholder="Search for products..."
                        >
                    </div>

                    <!-- Product Filter Section -->
                    <div class="shop-product-fillter">
                        <div class="totall-product">
                            <p>We found <strong class="text-brand" id="count">{{proCount}}</strong> items for you!</p>
                        </div>
                        <div class="sort-by-product-area">
                            <div class="sort-by-cover mr-10">
                                <div class="sort-by-product-wrap">
                                    <div class="sort-by">
                                        <span><i class="fi-rs-apps"></i> Show</span>
                                    </div>
                                    <div class="sort-by-dropdown-wrap">
                                        <span> <i class="fi-rs-angle-small-down"></i></span>
                                    </div>
                                </div>
                                <div class="sort-by-dropdown">
                                    <ul>
                                        <li><a onclick="limits(1)">1</a></li>
                                        <li><a onclick="limits(3)">3</a></li>
                                        <li><a onclick="limits(6)">6</a></li>
                                        <li><a onclick="limits(9)">9</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Product List Section -->
                    <div id="pro_container">
                        <div class="row product-grid-4">
                            {{#each proData}}
                            <div class="col-lg-3 col-md-4 col-12 col-sm-6">
                                <div class="product-cart-wrap mb-30">
                                    <div class="product-img-action-wrap">
                                        <div class="product-img product-img-zoom">
                                            <a href="/productview?id={{this._id}}">
                                                <img class="default-img" src="{{this.imageUrl.[0]}}" alt="{{this.name}}">
                                                {{#if this.imageUrl.[1]}}
                                                <img class="hover-img" src="{{this.imageUrl.[1]}}" alt="{{this.name}} - hover">
                                                {{/if}}
                                            </a>
                                        </div>
                                        
                                        <div class="product-badges product-badges-position product-badges-mrg">
                                            {{#if this.offerAvailable}}
                                            <span class="hot">{{this.offerPercentage}}% Off</span>
                                            {{/if}}
                                        </div>
                                    </div>
                                    
                                    <div class="product-content-wrap">
                                        <div class="product-category">
                                            <a>{{this.category.category}}</a>
                                        </div>
                                        <h2><a href="/productview?id={{this._id}}">{{this.name}}</a></h2>
                                        <div class="rating-result">
                                            <span>{{#if this.offerAvailable}}Offer Available{{else}}No Offer{{/if}}</span>
                                        </div>
                                        <div class="product-price">
                                            <span>₹{{this.discountedPrice}}</span>
                                            {{#if this.offerAvailable}}
                                            <span class="old-price">₹{{this.price}}</span>
                                            {{/if}}
                                        </div>
                                        <div class="product-action-1 show"></div>
                                    </div>
                                </div>
                            </div>
                            {{/each}}
                        </div>
                    </div>

                    <!-- Pagination Section -->
                    <div class="pagination-area mt-15 mb-sm-5 mb-lg-0">
                        <nav aria-label="Page navigation example">
                            <ul class="pagination justify-content-start" id="paginationList">
                                {{#each pages}}
                                <li class="page-item {{#ifEquals this ../currentPage}}active{{/ifEquals}}">
                                    <a class="page-link" href="javascript:goToPage({{this}});">{{this}}</a>
                                </li>
                                {{/each}}
                            </ul>
                        </nav>
                    </div>
                </div>

                <!-- Sidebar Section -->
                <div class="col-lg-3 primary-sidebar sticky-sidebar">
                    <!-- Category Filter -->
                    <div class="widget-category mb-30">
                        <h5 class="section-title style-1 mb-30 wow fadeIn animated">Category</h5>
                        <ul class="categories">
                            {{#each loadCatData}}
                            <li><a href="javascript:void(0)" onclick="filterByCategory('{{this._id}}')">{{this.category}}</a></li>
                            {{/each}}
                        </ul>
                    </div>

                    <!-- Sort Filter -->
                    <div class="widget-category mb-30">
                        <h5 class="section-title style-1 mb-30 wow fadeIn animated">Sort</h5>
                        <ul>
                            <li><a href="javascript:void(0)" onclick="sortLowToHigh()">Price: Low to High</a></li>
                            <li><a href="javascript:void(0)" onclick="sortHighToLow()">Price: High to Low</a></li>
                            <li><a href="javascript:void(0)" onclick="sortAZ()">A - Z</a></li>
                            <li><a href="javascript:void(0)" onclick="sortZA()">Z - A</a></li>
                            <br>
                            <a onclick="clearfilter()" class="btn btn-sm btn-default">
                                <i class="fi-rs-filter mr-5"></i> Clear Filter
                            </a>
                        </ul>
                    </div>

                    <!-- New Arrivals Section -->
                    <div class="sidebar-widget product-sidebar mb-30 p-30 bg-grey border-radius-10">
                        <div class="widget-header position-relative mb-20 pb-10">
                            <h5 class="widget-title mb-10">New arrivals</h5>
                            <div class="bt-1 border-color-1"></div>
                        </div>
                        {{#each newProduct}}
                        <div class="single-post clearfix">
                            <div class="image">
                                <img src="{{this.imageUrl.[0]}}" alt="{{this.name}}">
                            </div>
                            <div class="content pt-10">
                                <h5><a href="/productview?id={{this._id}}">{{this.name}}</a></h5>
                                <p class="price mb-0 mt-5">₹{{this.price}}</p>
                                <div class="product-rate">
                                    <div class="product-rating" style="width:90%"></div>
                                </div>
                            </div>
                        </div>
                        {{/each}}
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<!-- JQuery and Sweetalert Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    let currentPage = 1;
    let currentSort = '';
    let currentCategory = '';
    let searchQuery = '';
    let limit = 9;

    // Search functionality with debouncing
    let searchTimeout;
    const productSearchInput = document.getElementById('productSearchInput');
    
    if (productSearchInput) {
        productSearchInput.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchQuery = e.target.value.trim();
                currentPage = 1;
                fetchProducts();
            }, 500);
        });
    }

    const fetchProducts = () => {
        $.ajax({
            url: '/search',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                searchQuery,
                sortOption: currentSort,
                categoryFilter: currentCategory,
                page: currentPage,
                limit,
            }),
            success: (data) => {
                updateProductList(data.products);
                updatePagination(data.totalProducts);
                updateProductCount(data.totalProducts);
            },
            error: (error) => {
                console.error('Error fetching products:', error);
            },
        });
    };

    const updateProductList = (products) => {
        const productList = $('#pro_container .row.product-grid-4');
        productList.empty();

        if (products.length === 0) {
            productList.html('<div class="col-12"><h2 class="text-center m-5">No products available</h2></div>');
            return;
        }

        products.forEach((product) => {
            const displayPrice = product.discountPrice || product.price;
            const hasDiscount = product.discountPrice && product.discountPrice < product.price;
            
            const productHtml = `
                <div class="col-lg-3 col-md-4 col-12 col-sm-6">
                    <div class="product-cart-wrap mb-30">
                        <div class="product-img-action-wrap">
                            <div class="product-img product-img-zoom">
                                <a href="/productview?id=${product._id}">
                                    <img class="default-img" src="${product.imageUrl[0] || ''}" alt="${product.name || ''}">
                                    ${product.imageUrl?.[1] ? 
                                        `<img class="hover-img" src="${product.imageUrl[1]}" alt="${product.name || ''} hover">` : 
                                        ''}
                                </a>
                            </div>
                            <div class="product-action-1">
                                <a aria-label="Quick view" class="action-btn hover-up" href="/productview?id=${product._id}">
                                    <i class="fi-rs-search"></i>
                                </a>
                                <a data-id="${product._id}" aria-label="Add To Wishlist" class="wish action-btn hover-up" href="#">
                                    <i class="fi-rs-heart"></i>
                                </a>
                            </div>
                            <div class="product-badges product-badges-position product-badges-mrg">
                                ${product.offerAvailable ? `<span class="hot">${Math.round(product.offerPercentage)}% Off</span>` : ''}
                            </div>
                        </div>
                        <div class="product-content-wrap">
                            <div class="product-category">
                                <a href="#">${product.category?.category || 'Uncategorized'}</a>
                            </div>
                            <h2><a href="/productview?id=${product._id}">${product.name}</a></h2>
                            <div class="rating-result">
                                ${product.offerAvailable ? `<span>Offer Available</span>` : '<span>No Offer</span>'}
                            </div>
                            <div class="product-price">
                                <span>₹${displayPrice}</span>
                                ${hasDiscount ? `<span class="old-price">₹${product.price}</span>` : ''}
                            </div>
                            <div class="product-action-1 show"></div>
                        </div>
                    </div>
                </div>
            `;

            productList.append(productHtml);
        });
    };

    const updatePagination = (totalProducts) => {
        const paginationList = $('#paginationList');
        paginationList.empty();
        const totalPages = Math.ceil(totalProducts / limit);

        for (let i = 1; i <= totalPages; i++) {
            const activeClass = i === currentPage ? 'active' : '';
            const pageItem = `
                <li class="page-item ${activeClass}">
                    <a class="page-link" href="javascript:goToPage(${i});">${i}</a>
                </li>
            `;
            paginationList.append(pageItem);
        }
    };

    const updateProductCount = (totalProducts) => {
        $('#count').text(totalProducts);
    };

    const goToPage = (page) => {
        currentPage = page;
        fetchProducts();
    };

    function clearHighlights() {
        const filterLinks = document.querySelectorAll('.categories li a, .widget-category ul li a');
        filterLinks.forEach(link => {
            link.classList.remove('highlight');
        });
    }

    function filterByCategory(categoryId) {
        console.log('Filtering by category:', categoryId);
        clearHighlights();
        const selectedLink = document.querySelector(`a[onclick="filterByCategory('${categoryId}')"]`);
        if (selectedLink) {
            selectedLink.classList.add('highlight');
        }
        currentCategory = categoryId;
        currentPage = 1;
        fetchProducts();
    }

    function sortLowToHigh() {
        console.log('Sorting: Low to High (considering offers)');
        clearHighlights();
        const selectedLink = document.querySelector('a[onclick="sortLowToHigh()"]');
        if (selectedLink) selectedLink.classList.add('highlight');
        currentSort = 'priceAsc';
        currentPage = 1;
        fetchProducts();
    }

    function sortHighToLow() {
        console.log('Sorting: High to Low (considering offers)');
        clearHighlights();
        const selectedLink = document.querySelector('a[onclick="sortHighToLow()"]');
        if (selectedLink) selectedLink.classList.add('highlight');
        currentSort = 'priceDesc';
        currentPage = 1;
        fetchProducts();
    }

    function sortAZ() {
        console.log('Sorting: A - Z');
        clearHighlights();
        const selectedLink = document.querySelector('a[onclick="sortAZ()"]');
        if (selectedLink) selectedLink.classList.add('highlight');
        currentSort = 'nameAsc';
        currentPage = 1;
        fetchProducts();
    }

    function sortZA() {
        console.log('Sorting: Z - A');
        clearHighlights();
        const selectedLink = document.querySelector('a[onclick="sortZA()"]');
        if (selectedLink) selectedLink.classList.add('highlight');
        currentSort = 'nameDesc';
        currentPage = 1;
        fetchProducts();
    }

    const limits = (ct) => {
        limit = ct;
        currentPage = 1;
        fetchProducts();
    };

    function clearfilter() {
        clearHighlights();
        currentPage = 1;
        currentSort = '';
        currentCategory = '';
        searchQuery = '';
        limit = 9;
        
        // Clear the search input
        if (productSearchInput) {
            productSearchInput.value = '';
        }
        
        fetchProducts();
    }

    // Initial call
    fetchProducts();

    // Wishlist action
    $(document).ready(function () {
        $('#pro_container').on('click', '.wish.action-btn', function (event) {
            event.preventDefault();
            var $button = $(this);
            var id = $button.data('id');

            $.ajax({
                type: 'POST',
                url: '/addtowishlist',
                contentType: 'application/json',
                data: JSON.stringify({ id: id }),
                success: function (productData) {
                    if (productData.success) {
                        Swal.fire({
                            title: 'Success!',
                            text: 'Product Successfully added to Wishlist!!!',
                            icon: 'success',
                            confirmButtonText: 'Cool'
                        });
                    } else {
                        if (productData.message) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops',
                                text: productData.message,
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'Login Required',
                                showCancelButton: true,
                                confirmButtonText: 'Login',
                                confirmButtonColor: "#088178",
                                cancelButtonColor: "#d33",
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    window.location.href = '/login';
                                }
                            });
                        }
                    }
                },
                error: function (error) {
                    console.log('Error adding to wishlist', error);
                }
            });
        });
    });
</script>